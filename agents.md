## 1. Назначение и границы
- Единые правила разработки и эксплуатации «agentic RAG».
- Не покрывает бизнес-логику домена и приватные политики компании.

## 2. Python: лучшие практики (обязательные для PR)
- Типы повсюду (PEP 484), строгий mypy.
- Форматирование black, линт ruff.
- Pydantic v2 для DTO; публичные API только валидированные модели.
- Асинхронщина: asyncio + httpx; всегда таймауты и ретраи с джиттером.
- Логи структурные (structlog/logging), без PII/секретов; обязательные поля: request_id, workflow_id, doc_id.
- Конфиги только через ENV (pydantic-settings); дефолты безопасные; в коде не хардкодить секреты.
- Время — UTC/ISO-8601; размеры в байтах; числа с единицами.
- Идемпотентность и детерминизм для операций вне мира (скачивание, индексирование).
- Никакой магии: явные зависимости, DI-фабрики, чистые функции в ядре.
- Тесты: pytest + smoke на импорты/инициализацию + выборочные property-based; фикстуры не лезут в сеть.
- Профилирование и память: избегать глобальных кэшей без TTL; потокобезопасные клиенты.

## 3. Особенности проекта (обязательные правила)
- Оффлайн-режим: без ключей — «LLM off», fake embeddings (hash→vec), MMR как rerank.
- Версионирование индексов: поле index_version в payload и конфиг имени коллекции (blue/green).
- Схема идентификаторов: point_id = {doc_id}-{chunk_id}; в payload хранить doc_id, chunk_id, source_uri, ingested_at.
- Консистентность эмбеддингов: одна EMBEDDING_DIM на коллекцию; проверять при старте/ensure.
- Бюджеты: лимиты на токены/латентность/стоимость через ENV; падать ранним отказом при превышении.
- Наблюдаемость: трейсинг (OpenTelemetry — TODO), метрики RAG (Recall@k/Groundedness/Cost).
- Документы: только text/plain и text/html в MVP; PDF/Office — TODO в ingest.
- TODO: Hybrid BM25+dense.

## 4. Temporal: надёжные воркфлоу и активити
- Детерминизм в воркфлоу: никаких вызовов сети/рандома/времени (только через активити или патчи).
- Активити: всегда таймауты, экспоненциальные ретраи, heartbeat на длительных шагах (chunk/embed).
- Signals/Queries: cancel обрабатывается корректно; progress (0–100) обязателен.
- Версионирование воркфлоу: использовать patch-маркеры при изменениях; миграции индексов — отдельные воркфлоу.
- Идемпотентность: повторный вызов активити не должен дублировать индексацию (проверки по doc_id/chunk_id).

## 5. RAG/LLM: контракты и гардрейлы
- Retrieval: search (top-50), затем rerank → top_k (по ENV).
- Rerank: провайдер из ENV; при недоступности — MMR; документировать параметры (λ/диверсификация).
- Компрессия: no-op по умолчанию; интерфейс под LLMLingua (TODO).
- Промпт-политика: «отвечай только по источникам», обязательные цитаты, маркируй даты.
- Свежесть: веб-допоиск включается флагом; в ответе — источники с датами.
- Безопасность: запрет утечки секретов/PII, ограничение инструментов агента (allow-list), лимиты на глубину действий.
- TODO: GraphRAG.

## 6. Агенты: дизайн-паттерны и договоры инструментов
- Паттерны: ReAct (план → действие → наблюдение), Decomposition (подзапросы), CRAG/Self-RAG (самопроверка/решение «ретривить или нет») (TODO).
- Инструменты агента: каждый tool описан контрактом (вход/выход/побочные эффекты/таймаут/идемпотентность).
- Ограничения: агент не пишет в индекс/хранилище без явного шага воркфлоу; сетевые вызовы — только через адаптеры.
- Трейсинг: каждое действие агента — логируемое событие с request_id и ссылкой на контекст.

## 7. Безопасность и соответствие
- Секреты только из ENV/секрет-менеджера; никакого логирования ключей.
- PII: минимизация, маскирование, удаление по TTL.
- Лицензии зависимостей — фиксировать в uv.lock; внешние модели — с явной лицензией.

## 8. Тестирование и оценка качества
- Юнит-тесты для пакетов, smoke для сервисов, интеграционные тесты без реальной сети (mocks).
- RAG-оценка: nightly джобой (Temporal) на золотом наборе; отчёт: Recall@k, Answer-Relevancy, Groundedness, Cost.
- TODO: Self-RAG/CRAG.

## 9. Наблюдаемость, SLO и инциденты
- SLO: P95 латентности /query, доля «ответов без источников» < N%, ошибки индексации < M%.
- Алерты на ретраи > порога, рост стоимости/токенов, деградацию Recall@k.
- TODO: OpenTelemetry.

## 10. Процесс разработки
- Коммиты: Conventional Commits; PR обязательный CI (lint/mypy/tests).
- Pre-commit хуки (формат/линт); код-ревью — чек-лист из этого файла.
- Версионирование: семвер пакетов packages/*; релиз-теги на сервисы apps/*.

## 11. Глоссарий проекта
- chunk — минимальный фрагмент документа.
- overlap — перекрытие между chunk'ами.
- rerank — переупорядочивание результатов.
- MMR — Maximal Marginal Relevance, диверсификация.
- groundedness — подтверждённость ответа источниками.
- index_version — версия коллекции для blue/green индекса.
- workflow/activity/signal/query — сущности Temporal.
